# ゲームデザイン仕様

レトロ風トントン相撲バトルゲームのゲームメカニクスとバランス設計を説明します。

## ゲームコンセプト

レトロな相撲テーマで、**連打ボタン**と**物理シミュレーション**で楽しむ対戦型ゲーム。

### コアメカニクス

**トントン相撲バトル**：
- プレイヤーは「トン！」ボタンを連打して力士を動かす
- 連打により振動が発生し、物理シミュレーションで力士が前進
- 重力・慣性・減衰による本物のような動き
- 相手を土俵外に押し出すか転倒させれば勝利

### コアループ

```
タイトル画面
    ↓
試合開始
    ↓
1本勝負（AI対戦）
    ├→ トン！ボタンを連打
    ├→ 物理演算で力士が動く
    └→ 相手を押し出すor転倒させる
    ↓
リザルト表示（勝敗のみ）
    ↓
連続挑戦 / タイトルへ戻る
```

### プレイ時間

- 1ラウンド: 1〜2分
- テンポよく連戦可能

---

## 連打アクションシステム

### トン！ボタン

ゲームには1つの「トン！」ボタンがあり、連打することで力士を動かします。

#### 基本動作

**タップ時の挙動**：
- 前方への衝撃力: 2.0 N
- 上方への反発力: 0.5 N
- 微小な回転揺れ: ±0.1 rad/s（ランダム）

**物理シミュレーション**：
```typescript
// タップごとに力を加える
velocity.z += TAP_FORCE        // 前方へ加速
velocity.y += TAP_BOUNCE       // 上方へ跳ねる
angularVelocity += random(-0.1, 0.1)  // 微小な揺れ
```

#### 連打戦略

**連打速度による効果**：
- **速い連打**（0.1秒間隔）: 安定した前進、揺れが少ない
- **遅い連打**（0.5秒間隔）: 大きな跳ねと揺れ、転倒リスク増
- **リズミカルな連打**（0.2-0.3秒間隔）: バランスよく前進

**戦略的使用**：
- 相手を押し込む時: 速い連打で安定前進
- 距離を詰める時: リズミカルな連打
- 相手が転倒しそうな時: 一気に押し込む連打

### 物理パラメータ

**重力**：
- 重力加速度: 9.8 m/s²
- 常に下方向に作用

**減衰（摩擦）**：
- 速度減衰率: 0.92 /フレーム（毎フレーム8%減速）
- 自然に停止する設計

**回転減衰**：
- 角速度減衰率: 0.95 /フレーム
- 揺れが自然に収まる

---

## 物理シミュレーションシステム

### 物理演算の仕組み

トントン相撲は約100行のカスタム物理エンジンで動作します。外部ライブラリは使用せず、シンプルながら本物のような動きを実現しています。

**毎フレームの更新処理**：

```typescript
// 1. 重力を適用
velocity.y -= GRAVITY * deltaTime;

// 2. 速度で位置を更新
position.x += velocity.x * deltaTime;
position.y += velocity.y * deltaTime;
position.z += velocity.z * deltaTime;

// 3. 減衰を適用（摩擦）
velocity.x *= DAMPING;
velocity.y *= DAMPING;
velocity.z *= DAMPING;

// 4. 回転を更新
rotation.x += angularVelocity * deltaTime;
angularVelocity *= 0.95;  // 回転減衰
```

### 転倒判定システム

**転倒条件**：
- 傾き角度: 60°以上（Math.PI / 3 rad）
- 転倒速度: 0.5 rad/s 以上で倒れている

**判定処理**：
```typescript
function checkFallCondition(fighter: Fighter): boolean {
  const isTilted = Math.abs(fighter.rotation.x) > FALL_ANGLE;
  const isFalling = Math.abs(fighter.angularVelocity) > MIN_FALL_VELOCITY;
  return isTilted && isFalling;
}
```

**転倒演出**：
- 転倒判定時に即座に敗北
- 力士が土俵に倒れるアニメーション
- リザルト画面へ遷移

### 衝突システム

**力士同士の衝突**：
- 距離判定による簡易衝突検出
- 接触時に速度ベクトルを反転・減衰
- 押し合いの演出

**土俵境界**：
- Y座標が0未満で地面に接地
- 接地時に跳ね返り（反発係数: 0.3）
- 自然な着地動作

---

## 土俵と勝敗判定

### 土俵仕様

**サイズ**：
- 半径: 4.5ユニット
- 円形（Three.jsのCylinder + Torus）

**色**：
- 本体: 茶色（#8b4513 - dohyo earth brown）
- 縁: ゴールド（#ffd700）

### 勝利条件

**以下のいずれかを満たすと勝利**：

1. **相手を土俵外に押し出す**
   - 相手の座標が土俵中心から4.5ユニット超
   - 連打で押し込んで土俵外へ

2. **相手を転倒させる**
   - 相手の傾き角度が60°以上
   - 連打による揺れで転倒を誘発

**敗北条件**：
- 自分が土俵外に出る
- 自分が転倒する（60°以上傾く）

**引き分け**：
- 引き分けなし（必ずどちらかが勝つ）

**判定の実装**：
```typescript
// 土俵外判定
const distanceFromCenter = Math.sqrt(x * x + z * z);
if (distanceFromCenter > RING_RADIUS) {
  // 敗北
}

// 転倒判定
if (Math.abs(rotation.x) > FALL_ANGLE &&
    Math.abs(angularVelocity) > MIN_FALL_VELOCITY) {
  // 敗北
}
```

---

## AIシステム（対戦相手）

### AI行動決定システム

**基本ロジック**：

AIは状況に応じてタップ速度を動的に調整します。完全な実装は [TECHNICAL_DESIGN.md](./TECHNICAL_DESIGN.md#aiエンジン) を参照してください。

**タップ速度の決定**:

- **近距離（< 2.0ユニット）**: 8～12 taps/sec - 高速タップで押し込む
- **自身が傾いている（> 0.6）**: 4～6 taps/sec - 控えめで安定化
- **相手が傾いている（> 0.5）**: 10～15 taps/sec - 攻撃チャンス
- **デフォルト**: 5～8 taps/sec - 中程度のバランス型

**ランダム性**：
- タップ速度に幅を持たせて予測困難に
- 状況に応じた判断で人間らしさを演出
- 連続同一パターンを避ける自然な変化

---

## バランス設計

### 物理パラメータ一覧

物理定数の完全な定義と実装詳細は [TECHNICAL_DESIGN.md](./TECHNICAL_DESIGN.md#物理定数) を参照してください。

**主要な定数**:
- `GRAVITY: 9.8` m/s² - 重力加速度
- `DAMPING: 0.92` - 速度減衰率（毎フレーム8%減速）
- `TAP_FORCE: 2.0` N - 前方への衝撃力
- `TAP_BOUNCE: 0.5` N - 上方への反発力
- `FALL_ANGLE: π/3` (60°) - 転倒判定の閾値
- `RING_RADIUS: 4.5` - 土俵の半径（ユニット）

### 物理バランスの調整

**タップ力の影響**：
- **TAP_FORCE（前方力）**:
  - 1.0: 弱い前進、転倒しにくい
  - 2.0: バランスの取れた前進（標準）
  - 3.0: 強い前進、転倒しやすい

- **TAP_BOUNCE（上方力）**:
  - 0.0: 跳ねない、滑るような動き
  - 0.5: 適度な跳ね（標準）
  - 1.0: 大きく跳ねる、転倒リスク増

**摩擦の影響**：
- **DAMPING（減衰率）**:
  - 0.85: 素早く停止、機敏な動き
  - 0.92: バランスの取れた減速（標準）
  - 0.98: ゆっくり停止、慣性が強い

### 試合時間バランス

**想定試合時間**：
- 標準: 1〜2分
- 最速決着: 30秒（一方的な押し込み）
- 長期戦: 2.5分（拮抗した連打合戦）

**調整要素**：
- TAP_FORCE（前進速度）
- DAMPING（動きの機敏さ）
- FALL_ANGLE（転倒しやすさ）

---

## UXデザイン

### レトロスタイリング

**カラーパレット**（相撲テーマ）：

```css
:root {
  --retro-bg: #3d2817;      /* 土俵の土色（dohyo earth brown） */
  --retro-fg: #f4e4c1;      /* まわしのクリーム色（mawashi cream） */
  --retro-accent: #8b4513;  /* 茶色まわし（brown mawashi） */
  --retro-dark: #1a0f08;    /* 深い土色（deep earth） */
  --action-highlight: #ffd700;  /* アクションハイライト（ゴールド） */
}
```

**フォント**：
- M PLUS 1（日本語対応、レトロ風）

**UIコンポーネント**：
- 太いボーダーでクッキリした境界
- ボタンは押下時に視覚フィードバック
- シンプルなレイアウト

### 画面レイアウト

**上部HUD**：
- 試合ステータス
- タイマー（optional）
- プレイヤー名表示

**中央エリア**：
- 3D土俵シーン
- カメラ固定（斜め上から俯瞰）
- 力士の物理演算による動き

**下部コントロール**：
- 大きな「トン！」ボタン（1つのみ）
  - サイズ: 最低100×100px
  - 連打しやすいデザイン
  - タップ時に視覚フィードバック
- 連打回数カウンター（optional）

### フィードバック

**タップ時**：
- ボタンのビジュアル変化（縮小→復帰）
- タップエフェクト（リップル）
- 力士の跳ね上がり（物理演算）
- タップ音（optional）

**衝突時**：
- 力士同士がぶつかる演出
- 速度ベクトルの反転・減衰
- 衝突音（optional）

**転倒時**：
- 力士が倒れるアニメーション
- スローモーション演出（optional）
- 敗北判定表示

**勝利/敗北時**：
- リザルト画面へ遷移
- 勝敗テキスト表示
- "再戦" / "タイトルへ" ボタン

### アクセシビリティ

**タッチターゲット**：
- ボタンサイズ: 最低100×100px（大きめ）
- 画面下部中央に配置
- 誤タップ防止の余白

**視覚フィードバック**：
- タップ時の明確な視覚変化
- 力士の動きで連打効果を確認
- 転倒・場外時の明確な表示

---

## テストとバランス調整

### テスト項目

- [ ] 1本勝負平均時間が1〜2分
- [ ] 連打による力士の動きが自然
- [ ] AIとプレイヤーの勝率が適切（40-60%）
- [ ] 物理シミュレーションが安定動作
- [ ] 転倒判定が正確（60°閾値）
- [ ] 土俵外判定が正確（4.5ユニット超）
- [ ] 30fps以上で動作（モバイル）
- [ ] バンドルサイズ < 1.5MB

### バランス調整方針

**調整サイクル**：
1. 物理パラメータ仮設定
2. テストプレイ
3. データ収集（試合時間、勝敗条件の比率）
4. 分析と再調整

**重点観察項目**：
- 連打の感触（レスポンス、爽快感）
- 試合時間の分布
- 勝利条件の比率（押し出し vs 転倒）
- 物理演算の安定性（転倒頻度、場外頻度）
- AI連打パターンの適切さ

**物理パラメータのチューニング**：
```typescript
// 開発モード用の調整パネル（optional）
const DEV_PHYSICS_PANEL = {
  GRAVITY: [5, 9.8, 15],       // 調整可能な範囲
  TAP_FORCE: [1.0, 2.0, 3.0],
  TAP_BOUNCE: [0.0, 0.5, 1.0],
  DAMPING: [0.85, 0.92, 0.98],
};
```

---

## 参考資料

- シンプルな対戦ゲームのバランス設計
- レトロゲームのUXパターン
- アクションゲームのフィードバック設計
