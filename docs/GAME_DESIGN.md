# ゲームデザイン仕様

レトロ風相撲バトルゲームのゲームメカニクスとバランス設計を説明します。

## ゲームコンセプト

レトロな相撲テーマで、**連打で相手を押し出す**シンプルで爽快な対戦型ゲーム。

### コアメカニクス

**連打バトル**：
- プレイヤーは「トン！」ボタンを連打して相手を押す
- 連打すればするほど強い力で押せる
- 物理エンジンによる転倒・押し出しのリアルな挙動
- 相手を土俵外に押し出すか、転倒させれば勝利

### コアループ

```
タイトル画面
    ↓
試合開始
    ↓
1本勝負（AI対戦）
    ├→ トン！ボタンを連打
    ├→ 相手を押す・傾ける
    ├→ 物理シミュレーションで挙動決定
    └→ 相手を押し出すor転倒させる
    ↓
リザルト表示（勝敗・転倒率）
    ↓
連続挑戦 / タイトルへ戻る
```

### プレイ時間

- 1ラウンド: 1〜2分
- テンポよく連戦可能

---

## 連打システム

### トン！ボタン

ゲームの操作は1つのボタンのみ：**トン！ボタン**

**基本動作**：
- ボタンをタップ/クリックすると相手を押す力が発生
- 連打すればするほど強い力で押せる
- タップレート（1秒あたりのタップ回数）を測定して押す力を決定

**実装詳細**：
- `TapTracker`クラスが1秒間のスライディングウィンドウでタップを計測
- タップレートが高いほど強い前方向の力と上向きの跳ね返りが発生
- ランダムな横揺れ（角速度）も追加されて自然な動きを演出

---

## 物理エンジン

### カスタム物理シミュレーション

ゲームの挙動は約100行のカスタム物理エンジンで制御されます。

#### PhysicsState（物理状態）

```typescript
interface PhysicsState {
  position: Vector3;        // 位置（x, y, z）
  velocity: Vector3;        // 速度（x, y, z）
  angularVelocity: number;  // 角速度（回転の速さ）
  rotation: Euler;          // 回転角度（x, y, z）
  tipping: number;          // 傾き度（0-1、1で転倒）
  isFallen: boolean;        // 転倒したかどうか
}
```

#### 物理定数

```typescript
PHYSICS_CONSTANTS = {
  GRAVITY: 9.8,              // 重力加速度
  DAMPING: 0.95,             // 速度減衰率（毎フレーム）
  ANGULAR_DAMPING: 0.90,     // 角速度減衰率
  TAP_FORCE: 0.3,            // タップ1回あたりの押す力
  TAP_BOUNCE: 0.2,           // タップ1回あたりの跳ね返り
  FALL_ANGLE: 0.6,           // 転倒判定の角度閾値（ラジアン）
  RING_RADIUS: 4.5           // 土俵の半径（ユニット）
}
```

#### シミュレーションステップ

毎フレーム、以下の順序で物理演算が実行されます：

1. **タップ力の適用**（プレイヤー/AI）
   - 前方向の力（位置に応じて方向決定）
   - 上向きの跳ね返り
   - ランダムな横揺れ（角速度）

2. **重力の適用**
   - `velocity.y -= GRAVITY * deltaTime`

3. **速度の減衰**
   - `velocity *= DAMPING`
   - `angularVelocity *= ANGULAR_DAMPING`

4. **位置の更新**
   - `position += velocity * deltaTime`

5. **回転の更新**
   - `rotation.x += angularVelocity * deltaTime`

6. **地面衝突の処理**
   - `if (position.y < 0)` → 地面に戻す + 速度反転

7. **傾き度の計算**
   - `tipping = Math.abs(rotation.x) / FALL_ANGLE`
   - `isFallen = tipping >= 1.0`

---

## 転倒メカニクス

### 転倒判定

力士の転倒は**回転角度（rotation.x）**で判定されます：

**傾き度（tipping）**:
- `tipping = |rotation.x| / FALL_ANGLE`
- 0.0 = 直立、1.0 = 転倒

**転倒条件**:
- `tipping >= 1.0` で転倒判定
- `isFallen = true` となり、敗北

**UI表示**:
- リザルト画面で転倒率（`tipping × 100%`）を表示
- 戦闘中に転倒ゲージとして表示可能

---

## 勝利条件

**以下のいずれかを満たすと勝利**：

1. **相手を転倒させる**
   - 相手の `isFallen = true`（転倒判定）

2. **相手を土俵外に押し出す**
   - 相手の座標が土俵中心から4.5ユニット超
   - `distance = √(x² + z²) > RING_RADIUS`

**敗北条件**：
- 自分が転倒する（`isFallen = true`）
- 自分が土俵外に出る（`distance > 4.5`）

---

## 土俵と判定

### 土俵仕様

**サイズ**：
- 半径: 4.5ユニット
- 円形（Three.jsのCylinder + Torus）

**色**：
- 本体: 茶色（#8b4513 - dohyo earth brown）
- 縁: ゴールド（#ffd700）

### 押し出し判定

**判定の実装**：
```typescript
// 土俵外判定
const distanceFromCenter = Math.sqrt(x * x + z * z);
if (distanceFromCenter > RING_RADIUS) {
  // 敗北
}
```

---

## AIシステム（対戦相手）

### ランク別AI難易度システム

AIの強さはプレイヤーの**番付（ランク）**に応じて自動的に調整されます。各階級ごとに異なる行動パターンを持ち、なめらかな難易度曲線を実現しています。

#### 5段階の難易度設定

**前頭（Maegashira）- 初心者向け**:
- 難易度倍率: 0.7（標準の70%）
- tipping停止閾値: 0.5（保守的に行動）
- タップレート: 1.3-1.8 taps/sec
- 性格: 慎重、練習相手として最適
- 期待勝率: 70-80%

**小結（Komusubi）- やや慎重**:
- 難易度倍率: 0.8（標準の80%）
- tipping停止閾値: 0.48
- タップレート: 1.5-2.0 taps/sec
- 性格: やや慎重、前頭より手強い

**関脇（Sekiwake）- バランス型**:
- 難易度倍率: 0.9（標準の90%）
- tipping停止閾値: 0.45
- タップレート: 1.6-2.3 taps/sec
- 性格: バランスの取れた戦い方
- 期待勝率: 50-60%（接戦）

**大関（Ozeki）- 積極的**:
- 難易度倍率: 1.0（標準）
- tipping停止閾値: 0.42（攻撃的）
- タップレート: 1.8-2.5 taps/sec
- 性格: 積極的、リスクを取って攻める

**横綱（Yokozuna）- ボス戦**:
- 難易度倍率: 1.2（標準の120%）
- tipping停止閾値: **なし**（絶対に止まらない！）
- タップレート: 2.2-3.3 taps/sec
- 土俵際パニックモード: 4.0-5.5 taps/sec（超攻撃）
- 性格: 最強、絶対に諦めない
- 期待勝率: 初見20-30%、習熟後50-60%

### 横綱専用AI - ボス戦メカニクス

横綱は他の階級と一線を画す特別な行動パターンを持ちます：

**絶対に止まらない**:
- 自身のtippingが0.7を超えても攻撃を継続
- 通常のAIなら停止する場面でも果敢に攻める
- 逆転を許さない圧倒的な攻撃力

**土俵際での覚醒**:
- 土俵中心から1.2ユニット以内に追い込まれると発動
- タップレートが4.0-5.5 taps/secへ急上昇
- 最後の力を振り絞る「土俵際の粘り」

**相手の弱体化を見逃さない**:
- 相手のtippingが0.3を超えると畳み掛ける
- タップレート3.8-5.0 taps/secで徹底的に攻める
- 勝機を逃さない戦略的AI

### AI状態遷移システム

AIは状況に応じて4つの状態を遷移します：

```
stopped（停止）
  └→ 自身のtippingが高い時（横綱以外）

cautious（慎重）
  └→ 基本状態、ランク別の基本タップレート

aggressive（積極的）
  └→ 相手が弱っている時、タップレート上昇

panic（土俵際パニック）
  └→ 横綱専用、土俵際での超攻撃モード
```

### テレメトリーシステム

バランス調整のため、各バトルのデータを自動収集しています：

**収集データ**:
- ランク別の勝率統計
- 平均試合時間
- プレイヤー/AIの最大tipping値
- AI状態遷移の履歴とタイミング

**データ保存**:
- LocalStorageに保存（キー: `'sumoBattleTelemetry'`）
- コンソールログにも出力
- 開発者向け分析データ

**ログ例**:
```
[Telemetry] Rank: yokozuna, Winner: player, Duration: 18.5s
[Telemetry] Max Tipping: Player 0.82, Opponent 0.91
[Telemetry] AI State Transitions: cautious→aggressive→panic→aggressive
```

---

## バランス設計

### 物理パラメータ一覧

主要な定数:
- `GRAVITY: 9.8` - 重力加速度（下向き）
- `DAMPING: 0.95` - 速度減衰率（毎フレーム95%に減衰）
- `ANGULAR_DAMPING: 0.90` - 角速度減衰率（毎フレーム90%に減衰）
- `TAP_FORCE: 0.3` - タップ1回あたりの前方向の力
- `TAP_BOUNCE: 0.2` - タップ1回あたりの上向き跳ね返り
- `FALL_ANGLE: 0.6` - 転倒判定の角度閾値（ラジアン、約34度）
- `RING_RADIUS: 4.5` - 土俵の半径（ユニット）
- `TAP_WINDOW: 1.0s` - タップレート測定のウィンドウ（1秒間）

### 試合時間バランス

**想定試合時間**：
- 標準: 1〜2分
- 最速決着: 30秒（一方的な連打）
- 長期戦: 2.5分（拮抗した攻防）

**調整要素**：
- タップ力の強さ（TAP_FORCE, TAP_BOUNCE）
- 速度減衰率（DAMPING, ANGULAR_DAMPING）
- 転倒判定の閾値（FALL_ANGLE）

---

## UXデザイン

### レトロスタイリング

**カラーパレット**（相撲テーマ）：

```css
:root {
  --retro-bg: #3d2817;      /* 土俵の土色（dohyo earth brown） */
  --retro-fg: #f4e4c1;      /* まわしのクリーム色（mawashi cream） */
  --retro-accent: #8b4513;  /* 茶色まわし（brown mawashi） */
  --retro-dark: #1a0f08;    /* 深い土色（deep earth） */
  --action-highlight: #ffd700;  /* アクションハイライト（ゴールド） */
}
```

**フォント**：
- M PLUS 1（日本語対応、レトロ風）

**UIコンポーネント**：
- 太いボーダーでクッキリした境界
- ボタンは押下時に視覚フィードバック
- シンプルなレイアウト

### 画面レイアウト

**上部HUD**：
- HPバー（プレイヤー/AI）
- ゲージバー
- タイマー（optional）

**中央エリア**：
- 3D土俵シーン
- カメラ固定（斜め上から俯瞰）
- 力士の動き

**下部コントロール**：
- トン！ボタン（中央に大きく配置）
  - サイズ: 最低100×100px（連打しやすい大きさ）
  - タップフィードバック（アニメーション）
  - 連打回数表示（オプション）

### フィードバック

**タップ時**：
- ボタンのビジュアル変化（スケール0.9倍）
- タップレート表示更新
- 力士の動き（物理エンジン）
- サウンド（optional）

**勝利/敗北時**：
- リザルト画面へ遷移
- 勝敗テキスト表示
- "再戦" / "タイトルへ" ボタン

### アクセシビリティ

**タッチターゲット**：
- ボタンサイズ: 最低80×80px
- 画面下部に配置
- 誤タップ防止の余白

**視覚フィードバック**：
- アクション時の明確な視覚変化
- クールダウン表示
- ゲージ表示

---

## 番付システム（Ranking Progression）

### 概要

本格的な相撲の階級制度を採用し、プレイヤーの成長と長期的なモチベーションを提供します。

### 階級（Rank）

**5段階の番付**:

| 階級 | 名称 | 説明 |
|------|------|------|
| 0 | 前頭（Maegashira） | 最低ランク、スタート地点 |
| 1 | 小結（Komusubi） | 第2階級 |
| 2 | 関脇（Sekiwake） | 第3階級 |
| 3 | 大関（Ozeki） | 第4階級 |
| 4 | 横綱（Yokozuna） | 最高位、頂点 |

### 昇進・降格ルール

**シンプルな連勝制**:

- **昇進条件**: 3連勝で次の階級へ昇進
- **降格条件**: 1敗で前の階級へ降格
- **例外**:
  - 前頭（最低ランク）: 降格なし
  - 横綱（最高ランク）: 降格なし（名誉保持）
- **連勝カウント**: 敗北時に0にリセット

### 昇進の流れ

```
前頭（スタート）
    ↓
  3連勝
    ↓
  小結
    ↓
  3連勝
    ↓
  関脇
    ↓
  3連勝
    ↓
  大関
    ↓
  3連勝
    ↓
  横綱（最高位）
```

### 戦績管理

**保存データ**:
- 現在の階級（0-4）
- 連勝数（0-3）
- 通算勝利数
- 通算敗北数

**永続化**:
- localStorageに保存
- ブラウザを閉じても進捗が保持される
- キー: `'sumoRanking'`

### UI表示

**タイトル画面**:
- 現在の番付を大きく表示（例: 「関脇」）
- 戦績表示（例: 「戦績: 15勝 7敗」）
- 次の昇進まで（例: 「あと2勝で大関」）

**リザルト画面**:
- 勝敗結果
- 番付の変動:
  - 昇進時: 「昇進！新 [階級名]」（ゴールドエフェクト）
  - 降格時: 「降格... [階級名]」
  - 維持時: 連勝カウント表示（例: 「連勝: 2/3」）

### 戦略的意味

**難易度の自然な上昇**:
- 低階級: 連勝しやすい（昇進が早い）
- 高階級: 連勝が難しい（維持が大変）
- 横綱到達: 大きな達成感

**リプレイバリュー**:
- 横綱到達を目指す長期目標
- 降格リスクが緊張感を生む
- 戦績の積み重ね

### テスト項目

番付システムのテスト:

- [ ] 初回起動時、前頭でスタート
- [ ] 3連勝で次の階級へ昇進
- [ ] 1敗で前の階級へ降格（前頭は降格なし）
- [ ] 横綱は敗北しても降格しない
- [ ] 連勝カウントが正確
- [ ] localStorageへの保存が動作
- [ ] ブラウザ再起動後も進捗が保持される

---

## テストとバランス調整

### テスト項目

- [ ] 1本勝負平均時間が1〜2分
- [ ] タップレート測定が正確（TapTracker）
- [ ] 物理シミュレーションが安定（重力、減衰、衝突）
- [ ] 転倒判定が正確（tipping >= 1.0）
- [ ] AIとプレイヤーの勝率が適切（40-60%）
- [ ] 土俵外判定が正確（4.5ユニット超）
- [ ] 30fps以上で動作（モバイル）
- [ ] バンドルサイズ < 1.5MB

### バランス調整方針

**調整サイクル**：
1. 物理パラメータ仮設定
2. テストプレイ
3. データ収集（試合時間、勝敗条件の比率）
4. 分析と再調整

**重点観察項目**：
- 連打の感触（レスポンス、爽快感）
- 試合時間の分布
- 勝利条件の比率（押し出し vs 転倒）
- AIの強さ（勝率）
- 転倒メカニクスの適切性

---

## 参考資料

- シンプルな対戦ゲームのバランス設計
- レトロゲームのUXパターン
- アクションゲームのフィードバック設計
